<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChadGPT</title>
    <link rel="icon" type="image/png" href="images/avatar/1.png">
    <style>
        /* Estilos generales */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        #response-container {
            margin-top: 20px;
        }

        #avatar {
            width: 400px;
            background-color: #ccc;
            display: block;
            margin: auto;
        }

        /* Estilos para la introducción */
        #intro-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        #intro-container img {
            max-width: 80%;
            max-height: 80%;
            opacity: 0;
        }
    </style>
</head>

<body>
    <!-- Contenedor de introducción -->
    <div id="intro-container">
        <img id="intro-image" src="images/intro/1.png" alt="Introducción">
        <button id="continue-button"
            style="display: block; margin-top: 20px; padding: 10px 20px; background-color: black; color: #00ff00; border: 2px solid #00ff00; border-radius: 4px; font-size: 16px; font-family: 'Courier New', Courier, monospace; cursor: pointer; text-transform: uppercase;">
            Continuar
        </button>
        <div
            style="position: fixed; bottom: 10px; width: 100%; text-align: center; color: #ff0095; font-size: 14px; font-family: 'Courier New', Courier, monospace; background-color: black; padding: 5px;">
            Para los grosos de <a
                href="https://open.spotify.com/intl-es/artist/6I8TDGeUmmLom8auKPzMdX?si=a9Ip8NgOScmyq8zmQv2YRA"
                target="_blank" style="color: #00ff00; text-decoration: none;">Ca7riel y Paco Amoroso</a>, de <a
                href="https://www.linkedin.com/in/bertolinidiego/" target="_blank"
                style="color: #00ff00; text-decoration: none;">Berto</a>
        </div>
    </div>

    <!-- Video de fondo -->
    <video id="background-video" autoplay loop muted>
        <source src="videos/spiral.mp4" type="video/mp4">
        Tu navegador no soporta la reproducción de videos.
    </video>

    <div
        style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; width: 80%; max-width: 800px; gap: 10px;">
        <textarea id="user-input" rows="1" maxlength="500" placeholder="Escribe tu mensaje a ChadGPT..."
            style="flex: 1; padding: 10px; border: 2px solid #00ff00; border-radius: 4px; font-size: 16px; font-family: 'Courier New', Courier, monospace; background-color: black; color: #00ff00; resize: none; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></textarea>
        <button onclick="sendMessage(event)"
            style="display: block; padding: 10px 20px; background-color: black; color: #00ff00; border: 2px solid #00ff00; border-radius: 4px; font-size: 16px; font-family: 'Courier New', Courier, monospace; cursor: pointer; text-transform: uppercase;">
            Enviar
        </button>
    </div>

    <div id="avatar-container"
        style="background: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: float 3s ease-in-out infinite;">
        <img id="avatar" src="images/avatar/1.png" width="300" alt="Cabeza parlante" style="background: none;">
    </div>

    <style>
        @keyframes float {
            0% {
                transform: translate(-50%, -50%) translateY(0);
            }

            50% {
                transform: translate(-50%, -50%) translateY(-20px);
            }

            100% {
                transform: translate(-50%, -50%) translateY(0);
            }
        }
    </style>

    <div id="response-container" style="text-align: center; margin-top: 20px;">
        <p id="response-text"
            style="display: inline-block; background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 10px; max-width: 80%; word-wrap: break-word; font-size: 18px;">
        </p>
    </div>

    <script>
        // Manejo de la introducción
        const introContainer = document.getElementById("intro-container");
        const introImage = document.getElementById("intro-image");
        const continueButton = document.getElementById("continue-button");
        const introImages = [
            "images/intro/1.png",
            "images/intro/2.png",
            "images/intro/3.png",
            "images/intro/4.png",
            "images/intro/5.png",
            "images/intro/6.png"
        ];
        let currentImageIndex = 0;

        function showNextImage() {
            if (currentImageIndex > 0) {
                introImage.style.opacity = 0; // Ocultar imagen actual
            }
            if (currentImageIndex < introImages.length) {
                introImage.src = introImages[currentImageIndex];
                introImage.style.opacity = 1; // Mostrar nueva imagen
                currentImageIndex++;
                setTimeout(showNextImage, 200); // Cambiar cada 2 segundos
            } else {
                // Mostrar el botón de continuar al finalizar la transición
                continueButton.style.display = "block";
                introImage.src = introImages[introImages.length - 1]; // Mostrar la última imagen
                introImage.style.opacity = 1; // Asegurarse de que sea visible
            }
        }

        // Manejar el clic en el botón de continuar
        continueButton.addEventListener("click", () => {
            introContainer.style.transition = "opacity 0.5s ease-out"; // Agregar transición para el fade out
            introContainer.style.opacity = 0; // Ocultar contenedor de introducción
            setTimeout(() => {
                introContainer.style.display = "none"; // Eliminar contenedor
                document.getElementById("user-input").focus();
            }, 500); // Esperar a que la opacidad llegue a 0
        });

        // Iniciar la introducción
        showNextImage();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script>
        // Código existente para el manejo de mensajes y animaciones
        document.getElementById("user-input").addEventListener("keypress", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        });

        // document.getElementById("user-input").value = "hola amigo, como estas?";

        const mouthFrames = [
            "images/avatar/1.png", // Boca cerrada (reposo)
            "images/avatar/2.png", // Boca cerrada en movimiento
            "images/avatar/3.png",
            "images/avatar/4.png",
            "images/avatar/5.png",// Boca cerrada en movimiento
            "images/avatar/6.png",
            "images/avatar/7.png",
            "images/avatar/8.png",// Boca cerrada en movimiento
            "images/avatar/9.png",// Boca cerrada en movimiento
            "images/avatar/10.png",
            "images/avatar/11.png",
            "images/avatar/12.png",
            "images/avatar/13.png",
            "images/avatar/14.png",
            "images/avatar/15.png",
            "images/avatar/16.png",
            "images/avatar/17.png",
            "images/avatar/18.png",
            "images/avatar/19.png",// Boca cerrada en movimiento
            "images/avatar/20.png",
            "images/avatar/21.png",
            "images/avatar/22.png",
            "images/avatar/23.png",
            "images/avatar/24.png",
            "images/avatar/25.png",
            "images/avatar/26.png",
            "images/avatar/27.png",
            "images/avatar/28.png",
            "images/avatar/29.png",// Boca cerrada en movimiento
            "images/avatar/30.png",// Boca cerrada en movimiento
            "images/avatar/31.png",
            "images/avatar/32.png",
            "images/avatar/33.png",// Boca cerrada en movimiento
            "images/avatar/34.png",// Boca cerrada en movimiento
            "images/avatar/35.png",
            "images/avatar/36.png",// Boca cerrada en movimiento
            "images/avatar/37.png",
            "images/avatar/38.png",
            "images/avatar/39.png",
            "images/avatar/40.png",
            "images/avatar/41.png"
        ];

        async function sendMessage(event) {
            event.preventDefault(); // Prevent page refresh
            const userInput = document.getElementById("user-input").value;
            document.getElementById("user-input").value = "";
            if (!userInput.trim()) return;

            // Enviar solicitud a la API
            const response = await fetch("https://chad-gpt.azurewebsites.net/api/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ input_text: userInput })
            });

            if (!response.ok) {
                console.error('Error en la solicitud');
                return;
            }

            const data = await response.json();
            document.getElementById("response-text").textContent = data.response;
            const audioUrl = data.audio_file_path; // URL del archivo de audio devuelto por la API
            const responseAudio = await fetch("https://chad-gpt.azurewebsites.net/api/audios", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ filename: audioUrl })
            });
            const audioData = await responseAudio.blob();
            const audio = new Audio(URL.createObjectURL(audioData));

            // const audio = new Audio("http://localhost:7071/audios/" + audioUrl);
            audio.crossOrigin = "anonymous";
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);
            const analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            analyser.fftSize = 512;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const avatar = document.querySelector("#avatar-container img");

            function animateMouth() {
                analyser.getByteFrequencyData(dataArray);

                // // OPCION 1
                // let volume = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                // if (volume < 1) {
                //     avatar.src = mouthFrames[0]; // Boca cerrada
                // } else if (volume < 20) {
                //     avatar.src = mouthFrames[1]; // Boca semiabierta
                // } else if (volume < 30) {
                //     avatar.src = mouthFrames[2]; // Boca abierta
                // } else {
                //     avatar.src = mouthFrames[3]; // Boca más abierta
                // }

                // // OPCION 2
                // let volume = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                // const frameIndex = Math.min(
                //     Math.floor((volume / 255) * mouthFrames.length),
                //     mouthFrames.length - 1
                // );
                // avatar.src = mouthFrames[frameIndex];

                // OPCION 3
                let frameIndex = 0;
                analyser.getByteFrequencyData(dataArray);
                let volume = dataArray.reduce((a, b) => a + b, 0) / bufferLength;

                if (volume < 5) {
                    // Silencio: alternar entre imágenes de "Boca cerrada en movimiento"
                    const closedMouthFrames = [2, 5, 8, 9, 19, 29, 30, 33, 34, 36];
                    frameIndex = closedMouthFrames[Math.floor(Date.now() / 100) % closedMouthFrames.length];
                } else {
                    // Gesticular según el volumen
                    frameIndex = Math.min(
                        Math.floor((volume / 255) * (mouthFrames.length - 1)),
                        mouthFrames.length - 1
                    );
                }

                avatar.src = mouthFrames[frameIndex];

                if (!audio.paused) {
                    requestAnimationFrame(animateMouth);
                } else {
                    avatar.src = mouthFrames[0]; // Volver a boca cerrada cuando termine
                }
            }

            audio.onplay = () => {
                audioContext.resume().then(() => {
                    animateMouth();
                });
            };

            audio.play();

            // // Reproducir la respuesta en voz
            // const audioUrl = `http://127.0.0.1:8000/voice?text=${encodeURIComponent(data.response)}`;
            // speak(data.response); // Llama a la función speak para reproducir el audio
            // // playVoice(audioUrl);
            // //const audio = new Audio(audioUrl);
            // //audio.play();

            // // Aquí puedes agregar la animación de la cabeza
            // animateHead();
        }

        // function animateHead() {
        //     // Aquí va tu código de animación de la cabeza (puede ser con un gif o un video)
        //     const avatar = document.getElementById("avatar");
        //     avatar.style.backgroundColor = "blue"; // Cambio de color como ejemplo
        // }

        // async function generateVoice(text) {
        //     const response = await fetch(`http://127.0.0.1:8000/voice?text=${encodeURIComponent(text)}`);
        //     const data = await response.json();

        //     console.log("Audio generado:", data.audio_url);
        //     return data.audio_url;
        // }

        // async function playAudio(audioUrl) {
        //     const audio = new Audio(`http://127.0.0.1:8000${audioUrl}`);
        //     audio.play();
        // }


        // async function speak(text) {
        //     const audioUrl = await generateVoice(text);
        //     playAudio(audioUrl);
        // }
        // speak("Hola, cómo estás?");


        // async function playVoice(audioUrl) {
        //     const audio = new Audio(audioUrl);
        //     const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        //     const source = audioContext.createMediaElementSource(audio);
        //     const analyser = audioContext.createAnalyser();
        //     source.connect(analyser);
        //     analyser.connect(audioContext.destination);

        //     analyser.fftSize = 512;
        //     const bufferLength = analyser.frequencyBinCount;
        //     const dataArray = new Uint8Array(bufferLength);

        //     const avatar = document.getElementById("avatar"); // Imagen del avatar

        //     function animateMouth() {
        //         analyser.getByteFrequencyData(dataArray);
        //         let volume = dataArray.reduce((a, b) => a + b, 0) / bufferLength; // Calcula el volumen promedio

        //         if (volume < 10) {
        //             avatar.src = mouthFrames[0]; // Boca cerrada
        //         } else if (volume < 50) {
        //             avatar.src = mouthFrames[1]; // Boca semiabierta
        //         } else if (volume < 100) {
        //             avatar.src = mouthFrames[2]; // Boca abierta
        //         } else {
        //             avatar.src = mouthFrames[3]; // Boca más abierta
        //         }

        //         if (!audio.paused) {
        //             requestAnimationFrame(animateMouth);
        //         } else {
        //             avatar.src = mouthFrames[0]; // Volver a boca cerrada cuando termine
        //         }
        //     }

        //     audio.onplay = () => {
        //         audioContext.resume().then(() => {
        //             animateMouth();
        //         });
        //     };

        //     audio.play();
        // }

    </script>
</body>

</html>