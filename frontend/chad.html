<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChadGPT</title>
    <link rel="icon" type="image/png" href="images/avatar/1.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        #avatar {
            width: 400px;
            background-color: #ccc;
            display: block;
            margin: auto;
        }

        @keyframes float {
            0% {
                transform: translate(-50%, -50%) translateY(0);
            }

            50% {
                transform: translate(-50%, -50%) translateY(-20px);
            }

            100% {
                transform: translate(-50%, -50%) translateY(0);
            }
        }

        #avatar-container {
            background: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>

<body>

    <video id="background-video" autoplay loop muted playsinline style="pointer-events: none;">
        <source src="videos/spiral.mp4" type="video/mp4">
        Tu navegador no soporta la reproducción de videos.
    </video>

    <div
        style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; width: 80%; max-width: 800px; gap: 10px;">
        <textarea id="user-input" rows="1" maxlength="500" placeholder=""
            style="flex: 1; padding: 10px; border: 2px solid #00ff00; border-radius: 4px; font-size: 16px; font-family: 'Courier New', Courier, monospace; background-color: black; color: #00ff00; resize: none; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></textarea>
        <button onclick="sendMessage(event)"
            style="padding: 10px 20px; background-color: black; color: #00ff00; border: 2px solid #00ff00; border-radius: 4px; font-size: 16px; font-family: 'Courier New', Courier, monospace; cursor: pointer;">
            Enviar
        </button>
    </div>

    <div id="avatar-container">
        <img id="avatar" src="images/avatar/1.png" alt="Cabeza parlante" style="background: none; width: 350px;">
    </div>

    <div id="response-container" style="text-align: center; margin-top: 20px;">
        <p id="response-text"
            style="display: inline-block; background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 10px; max-width: 80%; word-wrap: break-word; font-size: 18px;">
        </p>
    </div>

    <script>
        const mouthFrames = Array.from({ length: 42 }, (_, i) => `images/avatar/${i + 1}.png`);
        let audioContext = null;

        // function preloadImages(imageArray) {
        //     imageArray.forEach(src => {
        //         const img = new Image();
        //         img.src = src;
        //     });
        // }

        // preloadImages(mouthFrames);

        document.getElementById("user-input").addEventListener("keypress", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        });

        async function sendMessage(event) {
            event.preventDefault();
            const userInput = document.getElementById("user-input").value.trim();
            document.getElementById("user-input").value = "";
            if (!userInput) return;

            // Creamos el AudioContext tras la interacción del usuario si aún no existe
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const response = await fetch("https://chad-gpt.azurewebsites.net/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ input_text: userInput })
            });

            if (!response.ok) {
                console.error('Error en la solicitud');
                return;
            }

            const data = await response.json();
            document.getElementById("response-text").textContent = data.response;

            const audioUrl = data.audio_file_path;
            const responseAudio = await fetch("https://chad-gpt.azurewebsites.net/api/audios", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename: audioUrl })
            });

            const audioData = await responseAudio.blob();
            const audio = new Audio(URL.createObjectURL(audioData));
            audio.crossOrigin = "anonymous";

            const source = audioContext.createMediaElementSource(audio);
            const analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            analyser.fftSize = 512;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const avatar = document.querySelector("#avatar-container img");

            function animateMouth() {
                analyser.getByteFrequencyData(dataArray);
                const frameIndex = Math.floor(Math.random() * mouthFrames.length);
                avatar.src = mouthFrames[frameIndex];

                if (!audio.paused) {
                    setTimeout(() => requestAnimationFrame(animateMouth), 250);
                } else {
                    avatar.src = mouthFrames[0];
                }
            }

            try {
                await audioContext.resume();
                await audio.play();
                animateMouth();
            } catch (err) {
                console.warn("El navegador bloqueó la reproducción automática de audio:", err);
                alert("Por favor, toca la pantalla o interactúa para permitir la reproducción de audio.");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const avatar = document.getElementById("avatar");
            avatar.addEventListener("load", () => {
                const avatarContainer = document.getElementById("avatar-container");
                avatarContainer.style.cssText = "background: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: float 3s ease-in-out infinite;";
            });
        });

        window.addEventListener("load", () => {
            const avatarContainer = document.getElementById("avatar-container");
            avatarContainer.style.cssText = "background: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: float 3s ease-in-out infinite;";
        });

        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(() => {
                const avatarContainer = document.getElementById("avatar-container");
                avatarContainer.style.cssText = "background: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: float 3s ease-in-out infinite;";
            }, 100); // Ajusta el tiempo si es necesario
        });

    </script>
</body>

</html>